<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HOD Dashboard - Campus Connect</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    
    <style>
        :root {
            --theme-primary: #f43a09;
            --theme-secondary: #ffb766;
            --theme-accent: #68d388;
            --theme-light-accent: #c2edda;
            --theme-bg-light: #FFFFFF;
            --theme-bg-medium: #f8f9fa;
            --text-dark: #212529;
            --border-color: #dee2e6;
            --glow-color: rgba(244, 58, 9, 0.6);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Poppins', sans-serif; }
        body { background-color: var(--theme-bg-medium); color: var(--text-dark); overflow-x: hidden; }
        .sidebar { width: 260px; background: var(--theme-bg-light); border-right: 1px solid var(--border-color); position: fixed; top: 0; left: 0; height: 100vh; z-index: 1001; transform: translateX(-100%); transition: transform 0.4s ease; }
        .sidebar.active { transform: translateX(0); }
        .sidebar-header { padding: 20px; display: flex; justify-content: space-between; align-items: center; font-size: 1.5rem; font-weight: 600; color: var(--theme-primary); border-bottom: 1px solid var(--border-color); }
        .sidebar-header .close-btn { font-size: 1.8rem; cursor: pointer; transition: transform 0.3s ease, color 0.3s ease; }
        .sidebar-header .close-btn:hover { transform: rotate(90deg); color: var(--theme-primary); }
        .sidebar-menu { list-style: none; padding-top: 20px; }
        .sidebar-menu li a { display: flex; align-items: center; padding: 15px 25px; color: var(--text-dark); text-decoration: none; font-size: 1.1rem; border-left: 4px solid transparent; transition: all 0.3s; }
        .sidebar-menu li a:hover, .sidebar-menu li a.active { background-color: #f1f1f1; border-left-color: var(--theme-primary); color: var(--theme-primary); }
        .sidebar-menu li a i { margin-right: 15px; width: 20px; }
        .header { background-color: var(--theme-bg-light); padding: 15px 30px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border-color); position: sticky; top: 0; z-index: 999; }
        .hamburger-menu { font-size: 1.5rem; cursor: pointer; transition: transform 0.3s ease, color 0.3s ease; }
        .hamburger-menu:hover { transform: scale(1.1); color: var(--theme-primary); }
        .college-title { display: flex; align-items: center; gap: 15px; position: absolute; left: 50%; transform: translateX(-50%); }
        .college-title img { width: 45px; height: 45px; }
        .college-title h1 { font-size: 1.3rem; font-weight: 600; white-space: nowrap; }
        .profile-container { position: relative; cursor: pointer; }
        .profile-container:hover #header-profile-pic { box-shadow: 0 0 10px var(--glow-color); }
        
        .profile-dropdown {
            position: absolute;
            top: calc(100% + 15px);
            right: 0;
            width: 240px;
            background-color: var(--theme-bg-light);
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            padding: 10px 0;
            opacity: 0;
            visibility: hidden;
            transform: translateY(10px) scale(0.95);
            transition: all 0.3s cubic-bezier(0.4, 0.0, 0.2, 1);
            z-index: 1000;
        }
        .profile-dropdown.active {
            opacity: 1;
            visibility: visible;
            transform: translateY(0) scale(1);
        }
        .profile-dropdown::before {
            content: '';
            position: absolute;
            top: -5px;
            right: 15px;
            width: 10px;
            height: 10px;
            background-color: var(--theme-bg-light);
            transform: rotate(45deg);
            box-shadow: -1px -1px 2px rgba(0,0,0,0.02);
        }
        .profile-dropdown a, .profile-dropdown .profile-info {
            display: flex; align-items: center; padding: 12px 20px;
            text-decoration: none; color: var(--text-dark);
        }
        .profile-dropdown .profile-info {
            border-bottom: 1px solid var(--border-color); padding-bottom: 15px; margin-bottom: 5px;
        }
        .profile-dropdown a {
            font-size: 0.95rem;
            transition: background-color 0.2s ease, color 0.2s ease;
            margin: 0 10px;
            border-radius: 6px;
        }
        .profile-dropdown a i { margin-right: 12px; width: 18px; color: #888; transition: color 0.2s ease; }
        .profile-dropdown a:hover {
            background-color: var(--theme-light-accent);
            color: var(--theme-accent);
        }
        .profile-dropdown a:hover i { color: var(--theme-accent); }

        #header-profile-pic { width: 40px; height: 40px; border-radius: 50%; border: 2px solid var(--theme-primary); object-fit: cover; transition: box-shadow 0.3s ease; }
        .main-content { transition: margin-left 0.4s ease; }
        .sidebar.active ~ .main-content { margin-left: 260px; }
        .page-content { padding: 30px; }
        .page { display: none; }
        .page.active { display: block; animation: fadeIn 0.5s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .page-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 15px;}
        .action-cards-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 30px; margin-top: 30px; }
        .action-card { background: var(--theme-bg-light); padding: 30px; border-radius: 15px; text-align: center; cursor: pointer; transition: all 0.3s ease; border: 1px solid var(--border-color); }
        .action-card:hover { transform: translateY(-10px); box-shadow: 0 0 25px -5px var(--glow-color); }
        .action-card .icon { font-size: 3.5rem; margin-bottom: 20px; color: var(--theme-primary); }
        .action-card h3 { font-size: 1.3rem; font-weight: 500; }
        .btn-primary { display: inline-flex; align-items: center; gap: 8px; padding: 10px 20px; background-color: var(--theme-primary); color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 1rem; font-weight: 500; transition: background-color 0.3s, transform 0.2s; }
        .btn-primary:hover { background-color: #d32f00; transform: scale(1.05); }
        .hod-class-card .btn-view:hover { transform: none; background-color: #d32f00; }
        .back-button { cursor: pointer; font-weight: 500; background: none; border: none; font-size: 1rem; display: inline-flex; align-items: center; gap: 5px; transition: transform 0.3s ease, color 0.3s ease; }
        .back-button:hover { transform: translateX(-5px); color: var(--theme-primary); }
        .data-table-container { background: #fff; border-radius: 10px; padding: 20px; overflow-x: auto; margin-top: 20px; }
        .data-table { width: 100%; border-collapse: collapse; }
        .data-table th, .data-table td { padding: 12px 15px; text-align: left; border-bottom: 1px solid var(--border-color); }
        .data-table th { background-color: var(--theme-bg-medium); font-weight: 600; }
        
        .profile-page-container {
            background-color: #fff;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.05);
        }
        .profile-page-grid {
            display: grid;
            grid-template-columns: 200px 1fr;
            gap: 40px;
            align-items: flex-start;
        }
        .profile-picture-container { text-align: center; }
        .profile-picture-container img {
            width: 180px; height: 180px;
            border-radius: 50%;
            object-fit: cover;
            border: 5px solid var(--theme-bg-light);
            box-shadow: 0 0 0 4px var(--theme-primary);
            margin-bottom: 20px;
        }
        .profile-picture-container .btn-upload { display: none; width: 100%; justify-content: center; }
        .profile-picture-container input[type="file"] { display: none; }
        .profile-details-container .form-group {
            margin-bottom: 20px;
        }
        .profile-details-container .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #555;
            font-size: 0.9rem;
        }
        .profile-details-container .form-group input {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 1rem;
            background-color: var(--theme-bg-medium);
            color: var(--text-dark);
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        .profile-details-container .form-group input:read-only {
            cursor: not-allowed;
            background-color: #e9ecef;
        }
         .profile-details-container .form-group input:not(:read-only):focus {
            outline: none;
            border-color: var(--theme-primary);
            box-shadow: 0 0 0 3px rgba(244, 58, 9, 0.1);
        }

        .staff-grid-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 25px; }
        .staff-card { background: #fff; border-radius: 10px; padding: 25px; text-align: center; cursor: pointer; transition: transform 0.3s ease, box-shadow 0.3s ease; border: 1px solid var(--border-color); }
        .staff-card:hover { transform: translateY(-8px); box-shadow: 0 12px 25px rgba(0,0,0,0.1); }
        .staff-card img { width: 90px; height: 90px; border-radius: 50%; object-fit: cover; margin-bottom: 15px; border: 3px solid var(--theme-primary); }
        .staff-card h4 { font-size: 1.25rem; font-weight: 600; margin-bottom: 5px; }
        .staff-card p { color: #6c757d; font-size: 0.9rem; }
        .hod-class-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; }
        .hod-class-card { background: #fff; border-radius: 12px; padding: 25px; display: flex; flex-direction: column; justify-content: space-between; align-items: center; text-align: center; box-shadow: 0 4px 12px rgba(0,0,0,0.05); transition: transform 0.3s ease, box-shadow 0.3s ease; }
        .hod-class-card:hover { transform: translateY(-5px); box-shadow: 0 8px 20px rgba(244, 58, 9, 0.15); }
        .class-card-icon { font-size: 2.5rem; color: #fff; background-color: var(--theme-primary); width: 60px; height: 60px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-bottom: 15px; }
        .class-card-title { font-size: 1.2rem; font-weight: 600; }
        .class-card-dept { font-size: 0.9rem; color: #6c757d; margin-bottom: 20px; }
        .hod-class-card .btn-view { margin-top: auto; width: 100%; }
        .marks-table input { width: 60px; padding: 5px; text-align: center; border: 1px solid #ccc; border-radius: 4px; }
        .marks-table th { font-size: 0.8rem; }
        .marks-table input:read-only { background-color: #e9ecef; cursor: not-allowed; }
        
        .tooltip { position: relative; display: inline-block; cursor: pointer; }
        .tooltip .tooltiptext { visibility: hidden; width: 220px; background-color: #333; color: #fff; text-align: left; border-radius: 6px; padding: 8px; position: absolute; z-index: 1; bottom: 125%; left: 50%; margin-left: -110px; opacity: 0; transition: opacity 0.3s; font-size: 0.8rem; line-height: 1.4; }
        .tooltip:hover .tooltiptext { visibility: visible; opacity: 1; }
        .todays-class-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(450px, 1fr));
            gap: 30px;
        }
        .course-card { 
            background-color: var(--theme-bg-light); 
            border-radius: 12px;
            border: none;
            box-shadow: 0 8px 25px rgba(0,0,0,0.08); 
            overflow: hidden; 
            transition: all 0.3s ease; 
            position: relative; 
        }
        .course-card:hover { 
            transform: translateY(-8px); 
            box-shadow: 0 12px 30px rgba(0,0,0,0.12); 
        }
        .course-card.completed { opacity: 0.75; }
        .course-card.completed:hover { transform: none; box-shadow: 0 8px 25px rgba(0,0,0,0.08); }
        .completed-tag { 
            position: absolute; top: 10px; right: -40px; 
            background-color: var(--theme-accent); color: white; 
            padding: 4px 40px; font-size: 0.8rem; font-weight: 600; 
            transform: rotate(45deg); text-align: center; z-index: 1; 
        }
        .course-card-header { 
            padding: 18px 25px; 
            background: linear-gradient(135deg, #ff8a65, #f4511e);
            border-bottom: none;
        }
        .course-card-header h4 { 
            font-size: 1.2rem; 
            font-weight: 600; 
            color: white;
            margin: 0; 
            text-shadow: 1px 1px 3px rgba(0,0,0,0.2);
        }
        .course-card-body { 
            padding: 25px; 
            background-color: #fff;
        }
        .course-card-details { 
            display: grid; 
            grid-template-columns: 1fr 1fr; 
            gap: 18px; 
            font-size: 0.9rem;
            color: #555; 
            margin-bottom: 20px;
            padding-bottom: 20px;
            border-bottom: 1px solid #f0f0f0;
        }
        .course-card-details p {
            margin: 0;
        }
        .course-card-details span { 
            display: block; 
            font-weight: 500;
            color: #888; 
            font-size: 0.8rem;
            margin-bottom: 4px;
            text-transform: uppercase;
        }
        .course-card-actions ul { list-style: none; padding: 0; margin: 0; }
        .course-card-actions li a { 
            display: flex; justify-content: space-between; align-items: center; 
            padding: 14px 10px;
            text-decoration: none; 
            color: #444;
            border-radius: 8px;
            transition: all 0.2s ease-in-out; 
            font-size: 0.95rem;
            font-weight: 500;
        }
        .course-card-actions li a:hover { 
            background-color: var(--theme-light-accent);
            color: var(--theme-accent); 
            padding-left: 15px;
        }
        .course-card-actions li a .fas { transition: transform 0.2s; }
        .course-card-actions li a:hover .fas { transform: translateX(5px); }
        .attendance-table-container .data-table td { vertical-align: middle; }
        .attendance-btn-group { display: flex; gap: 8px; }
        .attendance-btn-group button { padding: 6px 12px; border: 1px solid var(--border-color); border-radius: 6px; cursor: pointer; background-color: #fff; transition: all 0.2s; }
        .attendance-btn-group button.present.active { background-color: #10B981; color: white; border-color: #10B981; }
        .attendance-btn-group button.absent.active { background-color: #EF4444; color: white; border-color: #EF4444; }
        .attendance-btn-group button.onduty.active { background-color: #3B82F6; color: white; border-color: #3B82F6; }
        .reason-container { margin-top: 10px; display: none; }
        .reason-container textarea { width: 100%; padding: 8px; border-radius: 5px; border: 1px solid var(--border-color); font-size: 0.9rem; resize: vertical; }
        
        .staff-details-table { width: 100%; border-collapse: collapse; }
        .staff-details-table td { padding: 12px; border-bottom: 1px solid var(--border-color); }
        .staff-details-table td:first-child { font-weight: 600; color: #555; width: 150px; }
        .timetable-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; }
        .day-column h3 { text-align: center; background-color: var(--theme-primary); color: white; padding: 10px; border-radius: 8px 8px 0 0; }
        .day-column ul { list-style: none; padding: 0; }
        .day-column li { background: #fff; border: 1px solid var(--border-color); border-top: none; padding: 15px; }
        .day-column li:last-child { border-radius: 0 0 8px 8px; }
        .day-column li span { display: block; }
        .day-column .time { font-weight: 600; font-size: 1.1rem; }
        .day-column .class-details { font-size: 0.9rem; color: #6c757d; }
        .btn-save { background-color: var(--theme-accent); }
        .btn-edit { background-color: var(--theme-secondary); color: var(--text-dark); }
        .attendance-details-header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            flex-wrap: wrap; 
            gap: 20px; 
            margin-bottom: 10px; 
        }
        .filter-container { 
            display: flex; 
            gap: 10px; 
            align-items: center; 
            flex-wrap: wrap; 
        }
        .filter-btn { 
            padding: 8px 16px; 
            border: 1px solid var(--border-color); 
            border-radius: 20px; 
            background-color: #fff; 
            cursor: pointer; 
            font-weight: 500; 
            transition: all 0.2s ease; 
        }
        .filter-btn:hover { 
            background-color: #f1f1f1; 
        }
        .filter-btn.active { 
            background-color: var(--theme-primary); 
            color: white; 
            border-color: var(--theme-primary); 
        }

        .attendance-table { 
            table-layout: fixed; 
            width: 100%; 
        }
        .attendance-table .student-name-col { 
            width: 250px; 
            text-align: left;
        }
        .attendance-table .day-header { 
            background-color: #f7f3f2; 
            text-align: center; 
            padding: 8px; 
        }
        .attendance-table .period-header th { 
            text-align: center; 
            font-weight: 500; 
            color: #6c757d; 
            padding: 8px; 
            width: 45px;
        }
        .attendance-table tbody td { 
            text-align: center; 
            font-weight: 600; 
            padding: 10px 5px;
        }
        
        .report-view-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
        }
        .report-view-header h2 {
            font-size: 1.6rem;
            font-weight: 600;
        }
        .btn-secondary {
            background-color: #ff9800;
            color: white;
        }
        .btn-secondary:hover {
            background-color: #f57c00;
        }
        .report-controls {
            background: #fff;
            padding: 20px;
            border-radius: 10px;
            display: flex;
            align-items: flex-end;
            gap: 20px;
            margin-bottom: 25px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        }
        .report-controls .form-group {
            flex: 1;
        }
        .report-controls label {
            font-weight: 500;
            font-size: 0.9rem;
            margin-bottom: 5px;
            display: block;
        }
        .report-controls input[type="date"] {
            width: 100%;
            padding: 10px;
            border-radius: 6px;
            border: 1px solid var(--border-color);
            font-size: 1rem;
        }
        #report-table-container {
            display: none;
        }
        
        /* === NEW CALENDAR STYLES === */
        .calendar-container { 
            background: #fff; 
            border-radius: 10px; 
            padding: 20px; 
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        }
        .calendar-header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 20px; 
        }
        .calendar-header h3 { font-size: 1.5rem; }
        .calendar-header button { 
            background: none; 
            border: none; 
            font-size: 1.5rem; 
            cursor: pointer; 
            transition: color 0.3s; 
        }
        .calendar-header button:hover { color: var(--theme-primary); }
        .calendar-grid { 
            display: grid; 
            grid-template-columns: repeat(7, 1fr); 
            gap: 5px; 
        }
        .calendar-day-name { 
            text-align: center; 
            font-weight: 600; 
            color: #6c757d; 
            padding: 10px 0; 
        }
        .calendar-day { 
            border: 1px solid var(--border-color); 
            border-radius: 8px; 
            min-height: 100px; 
            padding: 10px; 
            cursor: pointer; 
            transition: background-color 0.2s; 
            display: flex; 
            flex-direction: column; 
        }
        .calendar-day:hover { background-color: #f8f9fa; }
        .calendar-day.not-current-month { background-color: #f8f9fa; color: #adb5bd; pointer-events: none; }
        .calendar-day.holiday { background-color: #ffeef0; }
        .calendar-day .day-number { font-size: 1.1rem; font-weight: 600; }
        .calendar-day.holiday .day-number { color: #d90429; }
        .calendar-day .day-activity { 
            font-size: 0.75rem; 
            margin-top: 5px; 
            color: #495057; 
            display: -webkit-box; 
            -webkit-line-clamp: 2; 
            -webkit-box-orient: vertical; 
            overflow: hidden; 
        }
        .form-modal { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background-color: rgba(0,0,0,0.5); z-index: 1002; display: none; 
            justify-content: center; align-items: center; 
        }
        .form-modal.active { display: flex; }
        .form-modal-content { 
            background-color: var(--theme-bg-light); padding: 30px; border-radius: 15px; 
            width: 90%; max-width: 400px; position: relative; 
        }
        .form-modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .form-modal-header .close-form-btn { font-size: 1.8rem; cursor: pointer; }

        /* Styles for event modal */
        #event-details-content ul { list-style-type: none; padding: 0; }
        #event-details-content li {
            background: var(--theme-bg-medium);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            border-left: 4px solid var(--theme-primary);
        }
        #event-details-content li h4 { margin: 0 0 5px 0; font-size: 1.1rem; }
        #event-details-content li p { margin: 0; color: #555; }
    </style>
</head>
<body>
    <nav class="sidebar" id="sidebar">
        <div class="sidebar-header"> HOD Menu <i class="fas fa-times close-btn" id="close-sidebar-btn"></i></div>
        <ul class="sidebar-menu">
            <li><a href="#" id="sidebar-home" class="nav-link active"><i class="fas fa-home"></i> Home</a></li>
            <li><a href="#" id="sidebar-staff" class="nav-link"><i class="fas fa-users-cog"></i> Staff Management</a></li>
            <li><a href="#" id="sidebar-classes" class="nav-link"><i class="fas fa-university"></i> Class Management</a></li>
            <li><a href="#" id="sidebar-marks" class="nav-link"><i class="fas fa-marker"></i> Mark Management</a></li>
            <li><a href="#" id="sidebar-attendance" class="nav-link"><i class="fas fa-calendar-check"></i> Attendance Report</a></li>
            <li><a href="#" id="sidebar-timetable" class="nav-link"><i class="fas fa-calendar-alt"></i> Timetable</a></li>
        </ul>
    </nav>
    <div class="main-content">
        <header class="header">
            <i class="fas fa-bars hamburger-menu" id="hamburger-menu"></i>
            <div class="college-title">
                <img src="/uploads/1st.jpg" alt="ESEC Logo" onerror="this.onerror=null;this.src='https://placehold.co/45x45/cccccc/ffffff?text=Logo';">
                <h1>Erode Sengunthar Engineering College</h1>
            </div>
            <div class="header-right">
                <div class="profile-container" id="profile-toggler">
                    <img id="header-profile-pic" src="https://placehold.co/48x48/cccccc/ffffff?text=H" alt="Profile Picture">
                    <div class="profile-dropdown" id="profile-dropdown">
                        <div class="profile-info"><div><p id="header-user-name" style="font-weight: 600;">Loading...</p><p id="header-user-role" style="font-size: 0.8rem; color: #6c757d;">HOD</p></div></div>
                        <a href="#" id="profile-section-link"><i class="fas fa-user-edit"></i> My Profile</a>
                        <a href="#" id="logoutBtn"><i class="fas fa-sign-out-alt"></i> Logout</a>
                    </div>
                </div>
            </div>
        </header>
        <main class="page-content">
            <div id="main-dashboard-view" class="page active">
                <div class="page-header"><h2 style="font-size: 1.8rem; font-weight: 600;" id="welcome-heading">Loading...</h2></div>
                
                <div id="course-workload-section">
                    <h2 style="font-size: 1.8rem; font-weight: 600; margin-bottom: 20px;">Today's Classes</h2>
                    <div class="todays-class-container" id="todays-class-cards-container">
                    </div>
                </div>

                <div class="action-cards-container">
                    <div id="view-staff-btn" class="action-card"><div class="icon"><i class="fas fa-users-cog"></i></div><h3>Staff Management</h3><p>View and manage staff.</p></div>
                    <div id="view-classes-btn" class="action-card"><div class="icon"><i class="fas fa-university"></i></div><h3>Class Management</h3><p>Oversee classes and attendance.</p></div>
                    <div id="view-marks-btn" class="action-card"><div class="icon"><i class="fas fa-marker"></i></div><h3>Mark Management</h3><p>Enter and report student marks.</p></div>
                    <div id="view-attendance-btn" class="action-card"><div class="icon"><i class="fas fa-calendar-check"></i></div><h3>Attendance Report</h3><p>Generate attendance reports.</p></div>
                    <div id="view-timetable-btn" class="action-card"><div class="icon"><i class="fas fa-calendar-alt"></i></div><h3>View Timetable</h3><p>See the full weekly schedule.</p></div>
                    <div id="view-calendar-btn" class="action-card">
                        <div class="icon"><i class="fas fa-calendar-day"></i></div>
                        <h3>Academic Calendar</h3>
                        <p>View the official schedule.</p>
                    </div>
                </div>
            </div>

            <div id="staff-directory-view" class="page"></div>
            <div id="staff-profile-details-view" class="page"></div>
            <div id="class-management-view" class="page"></div>
            <div id="class-attendance-details-view" class="page"></div>
            <div id="mark-management-view" class="page"></div>
            <div id="attendance-management-view" class="page"></div>
            <div id="attendance-details-view" class="page"></div>
            
            <div id="profile-view" class="page">
                 <div class="page-header">
                    <button class="back-button" onclick="showView('main-dashboard-view')"><i class="fas fa-arrow-left"></i> Back</button>
                    <h2>Edit User Profile</h2>
                    <div>
                        <button id="edit-profile-btn" class="btn-primary btn-edit"><i class="fas fa-edit"></i> Edit</button>
                        <button id="save-profile-btn" class="btn-primary btn-save" style="display: none;"><i class="fas fa-save"></i> Save Changes</button>
                    </div>
                </div>
                <div id="user-profile-form" class="profile-page-container">
                </div>
            </div>
            
            <div id="attendance-taking-view" class="page"></div>
            <div id="mark-entry-view" class="page"></div>
            <div id="lesson-plan-upload-view" class="page"></div>
            <div id="report-generator-view" class="page"></div>
            <div id="timetable-view" class="page"></div>
            <div id="calendar-view" class="page"></div> </main>
    </div>
    
    <div id="event-details-modal" class="form-modal">
        <div class="form-modal-content">
            <div class="form-modal-header">
                <h3 id="event-details-title">Events on Date</h3>
                <i class="fas fa-times close-form-btn" onclick="document.getElementById('event-details-modal').classList.remove('active')"></i>
            </div>
            <div id="event-details-content">
                <p>No events scheduled for this day.</p>
            </div>
        </div>
    </div>

    <script>
        let userProfileData = {};
        let currentReportData = null; 

        function showView(viewId) {
            document.querySelectorAll('.page').forEach(page => page.classList.remove('active'));
            const view = document.getElementById(viewId);
            if (view) view.classList.add('active');
            document.querySelectorAll('.sidebar-menu .nav-link').forEach(link => link.classList.remove('active'));
            let activeLink;
            if (viewId.includes('staff')) activeLink = document.getElementById('sidebar-staff');
            else if (viewId.includes('class-management') || viewId.includes('class-attendance-details')) activeLink = document.getElementById('sidebar-classes');
            else if (viewId.includes('mark')) activeLink = document.getElementById('sidebar-marks');
            else if (viewId.includes('attendance-management') || viewId.includes('attendance-details-view')) activeLink = document.getElementById('sidebar-attendance');
            else if (viewId.includes('timetable-view')) activeLink = document.getElementById('sidebar-timetable');
            else activeLink = document.getElementById('sidebar-home');
            if (activeLink) activeLink.classList.add('active');
        }

        function setupEventListeners() {
            document.getElementById('hamburger-menu').addEventListener('click', e => { e.stopPropagation(); document.getElementById('sidebar').classList.toggle('active'); });
            document.getElementById('close-sidebar-btn').addEventListener('click', () => document.getElementById('sidebar').classList.remove('active'));
            const profileToggler = document.getElementById('profile-toggler');
            if (profileToggler) { profileToggler.addEventListener('click', e => { e.stopPropagation(); document.getElementById('profile-dropdown').classList.toggle('active'); }); }
            document.addEventListener('click', e => { if (profileToggler && !profileToggler.contains(e.target)) { document.getElementById('profile-dropdown').classList.remove('active'); } });
            document.getElementById('sidebar-home').addEventListener('click', e => { e.preventDefault(); showView('main-dashboard-view'); });
            document.getElementById('sidebar-staff').addEventListener('click', e => { e.preventDefault(); populateStaffDirectory(); });
            document.getElementById('sidebar-classes').addEventListener('click', e => { e.preventDefault(); populateClassManagementView(); });
            document.getElementById('sidebar-marks').addEventListener('click', e => { e.preventDefault(); populateMarkManagementView(); });
            
            document.getElementById('sidebar-attendance').addEventListener('click', e => { e.preventDefault(); populateAttendanceManagementView(); });
            document.getElementById('profile-section-link').addEventListener('click', e => {
                e.preventDefault();
                populateNewProfilePage(userProfileData);
                showView('profile-view');
                document.getElementById('profile-dropdown').classList.remove('active');
            });
            
            document.getElementById('logoutBtn').addEventListener('click', e => { e.preventDefault(); localStorage.removeItem('loggedInUser'); window.location.href = 'login.html'; });
            document.getElementById('view-staff-btn').addEventListener('click', populateStaffDirectory);
            document.getElementById('view-classes-btn').addEventListener('click', populateClassManagementView);
            document.getElementById('view-marks-btn').addEventListener('click', populateMarkManagementView);
            document.getElementById('view-attendance-btn').addEventListener('click', populateAttendanceManagementView);

            document.getElementById('view-timetable-btn').addEventListener('click', populateFullTimetableView);
            document.getElementById('sidebar-timetable').addEventListener('click', e => { e.preventDefault(); populateFullTimetableView(); });
            document.getElementById('view-calendar-btn').addEventListener('click', () => populateCalendarView());
        }

        function formatTime12Hour(timeString) {
            if (!timeString) return '';
            const [hourString, minute] = timeString.split(':');
            const hour = +hourString;
            const period = hour >= 12 ? 'PM' : 'AM';
            const adjustedHour = hour % 12 || 12;
            const formattedHour = String(adjustedHour).padStart(2, '0');
            return `${formattedHour}:${minute} ${period}`;
        }

        async function initializeDashboard(user) {
            if (!user || !user.email) { window.location.href = 'login.html'; return; }
            try {
                const response = await fetch(`http://localhost:3001/api/profile?email=${encodeURIComponent(user.email)}`);
                if (!response.ok) throw new Error('Profile not found');
                const profile = await response.json();
                userProfileData = { ...profile, ...user };
                localStorage.setItem('loggedInUser', JSON.stringify(userProfileData));
                populateHeader(userProfileData);
                populateTodaysClasses();
            } catch (error) { console.error("Dashboard Init Error:", error); }
        }

        function populateHeader(profile) {
            if (!profile) return;
            document.getElementById('welcome-heading').textContent = `Welcome back, ${profile.name || 'HOD'}`;
            document.getElementById('header-user-name').textContent = profile.name || 'HOD';
            const imageUrl = profile.profile_picture_url ? `http://localhost:3001${profile.profile_picture_url}?t=${new Date().getTime()}` : `https://placehold.co/48x48/cccccc/ffffff?text=${profile.name ? profile.name.charAt(0) : 'H'}`;
            const profilePic = document.getElementById('header-profile-pic');
            profilePic.src = imageUrl;
            profilePic.onerror = function() { this.src = `https://placehold.co/48x48/cccccc/ffffff?text=${profile.name ? profile.name.charAt(0) : 'H'}`; };
        }
        
        // **FIXED FUNCTION**
        async function populateTodaysClasses() {
            const container = document.getElementById('todays-class-cards-container');
            if (!container) return;
            container.innerHTML = "<p>Loading today's schedule...</p>";
            try {
                // This single API call now handles the logic for working/non-working days on the backend
                const response = await fetch(`http://localhost:3001/api/staff/timetables/today?email=${encodeURIComponent(userProfileData.email)}`);
                if (!response.ok) {
                    throw new Error(`Server returned an error: ${response.status}`);
                }
                const data = await response.json();
                
                // The backend returns an empty array if it's a non-working day.
                if (!data.success || !data.todayTimetable || data.todayTimetable.length === 0) {
                    container.innerHTML = "<p>No classes scheduled for today. It might be a holiday or a non-working day. ðŸŽ‰</p>";
                    return;
                }

                container.innerHTML = data.todayTimetable.map(cls => {
                    const isCompletedClass = cls.status === 'Completed' ? 'completed' : '';
                    const completedTag = cls.status === 'Completed' ? '<div class="completed-tag">Completed</div>' : '';
                    const batch = cls.batch || new Date().getFullYear(); 
                    return `
                    <div class="course-card ${isCompletedClass}">
                        ${completedTag}
                        <div class="course-card-header"><h4>${cls.class_name}</h4></div>
                        <div class="course-card-body">
                            <div class="course-card-details">
                                <p><span>Batch:</span> ${batch}</p>
                                <p><span>Department:</span> ${cls.department}</p>
                                <p><span>Class:</span> Year ${cls.year} - Sem ${cls.semester} - Sec ${cls.section}</p>
                                <p><span>Course Code:</span> ${cls.course_code}</p>
                                <p><span>Time:</span> ${formatTime12Hour(cls.start_time)} - ${formatTime12Hour(cls.end_time)}</p>
                            </div>
                            <div class="course-card-actions">
                                <ul>
                                    <li><a href="#" onclick="showAttendanceTakingView('${cls.year}', '${cls.section}', '${cls.department}', '${cls.period_number}')">Attendance <i class="fas fa-chevron-right"></i></a></li>
                                    <li><a href="#" onclick="showMarkEntryView('${cls.year}', '${cls.section}', '${cls.department}')">Internal Mark <i class="fas fa-chevron-right"></i></a></li>
                                    <li><a href="#" onclick="showFileUploadView('${cls.course_code}', 'Lesson Plan')">Lesson Plan <i class="fas fa-chevron-right"></i></a></li>
                                </ul>
                            </div>
                        </div>
                    </div>`;
                }).join('');
            } catch (error) {
                console.error("Error fetching today's workload:", error);
                container.innerHTML = '<p style="color: red;">Could not load today\'s schedule.</p>';
            }
        }
        
        async function showAttendanceTakingView(year, section, department, period) {
            const container = document.getElementById('attendance-taking-view');
            showView('attendance-taking-view');
            container.innerHTML = `<div class="page-header">
                <button class="back-button" onclick="showView('main-dashboard-view')"><i class="fas fa-arrow-left"></i> Back to Dashboard</button>
                <h2>Take Attendance (Year: ${year}, Sec: ${section}, Period: ${period})</h2>
                <button class="btn-primary" id="save-attendance-btn"><i class="fas fa-save"></i> Save Attendance</button>
            </div>
            <div class="data-table-container attendance-table-container"><p>Loading students...</p></div>`;
            try {
                const res = await fetch(`http://localhost:3001/api/students/${department}/${year}/${section}`);
                const data = await res.json();
                if (!data.success) throw new Error(data.message);

                let tableHTML = `<table class="data-table">
                    <thead><tr><th>Register No</th><th>Student Name</th><th>Status</th></tr></thead>
                    <tbody>`;
                data.students.forEach(student => {
                    tableHTML += `
                    <tr data-reg-no="${student.register_number}">
                        <td>${student.register_number}</td>
                        <td>${student.student_name}</td>
                        <td>
                            <div class="attendance-btn-group">
                                <button class="present active" data-status="Present">Present</button>
                                <button class="absent" data-status="Absent">Absent</button>
                                <button class="onduty" data-status="OnDuty">On Duty</button>
                            </div>
                            <div class="reason-container">
                                <textarea placeholder="Enter reason for absence/on-duty..."></textarea>
                            </div>
                        </td>
                    </tr>`;
                });
                tableHTML += `</tbody></table>`;
                container.querySelector('.data-table-container').innerHTML = tableHTML;
                container.querySelectorAll('.attendance-btn-group button').forEach(button => {
                    button.addEventListener('click', function() {
                        const studentRow = this.closest('tr');
                        const reasonContainer = studentRow.querySelector('.reason-container');
                        this.parentElement.querySelectorAll('button').forEach(btn => btn.classList.remove('active'));
                        this.classList.add('active');
                        studentRow.dataset.status = this.dataset.status;
                        if (this.dataset.status === 'Absent' || this.dataset.status === 'OnDuty') {
                            reasonContainer.style.display = 'block';
                        } else {
                            reasonContainer.style.display = 'none';
                            reasonContainer.querySelector('textarea').value = '';
                        }
                    });
                });
                document.getElementById('save-attendance-btn').onclick = () => saveAttendance(year, section, department, period);
            } catch(error) {
                console.error("Failed to load students for attendance:", error);
                container.querySelector('.data-table-container').innerHTML = `<p style="color:red;">Could not load student list.</p>`;
            }
        }
        
        async function saveAttendance(year, section, department, period) {
            const saveBtn = document.getElementById('save-attendance-btn');
            saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
            saveBtn.disabled = true;
            const attendanceData = [];
            document.querySelectorAll('#attendance-taking-view tbody tr').forEach(row => {
                const activeBtn = row.querySelector('.attendance-btn-group button.active');
                attendanceData.push({
                    student_reg_no: row.dataset.regNo,
                    status: activeBtn.dataset.status,
                    reason: row.querySelector('.reason-container textarea').value,
                    attendance_date: new Date().toISOString().slice(0, 10),
                    period_number: period,
                    staff_id: userProfileData.id 
                });
            });
            try {
                const res = await fetch(`http://localhost:3001/api/attendance/save`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ attendanceData, year, section, department })
                });
                const result = await res.json();
                if (!result.success) throw new Error(result.message);
                alert('Attendance saved successfully!');
                showView('main-dashboard-view');
            } catch(error) {
                console.error('Error saving attendance:', error);
                alert('Failed to save attendance.');
            } finally {
                saveBtn.innerHTML = '<i class="fas fa-save"></i> Save Attendance';
                saveBtn.disabled = false;
            }
        }
        
        function showFileUploadView(courseCode, uploadType) {
            const container = document.getElementById('lesson-plan-upload-view');
            showView('lesson-plan-upload-view');
            container.innerHTML = `
            <div class="page-header">
                <button class="back-button" onclick="showView('main-dashboard-view')"><i class="fas fa-arrow-left"></i> Back</button>
                <h2>Upload ${uploadType} for ${courseCode}</h2>
            </div>
            <div class="data-table-container">
                <p>Select a file to upload. All document types are supported.</p>
                <br>
                <input type="file" id="file-upload-input" style="padding: 10px; border: 1px solid #ccc; border-radius: 5px;">
                <br><br>
                <button class="btn-primary" onclick="uploadFile()"><i class="fas fa-upload"></i> Upload File</button>
            </div>`;
        }
        
        async function showStaffDetails(staffId) {
            const container = document.getElementById('staff-profile-details-view');
            showView('staff-profile-details-view');
            container.innerHTML = `<div class="page-header"><button class="back-button" onclick="populateStaffDirectory()"><i class="fas fa-arrow-left"></i> Back to Staff List</button><h2>Staff Profile</h2><div></div></div><p>Loading details...</p>`;
            try {
                const [detailsRes, timetableRes] = await Promise.all([
                    fetch(`http://localhost:3001/api/staff/details/${staffId}`),
                    fetch(`http://localhost:3001/api/staff/timetables/${staffId}`)
                ]);
                if (!detailsRes.ok || !timetableRes.ok) throw new Error('Failed to fetch data.');
                const staff = await detailsRes.json();
                const timetable = await timetableRes.json();
                const personalInfoHtml = `
                <table class="staff-details-table">
                    <tbody>
                        <tr><td>Full Name</td><td>${staff.name || 'N/A'}</td></tr>
                        <tr><td>Email</td><td>${staff.email || 'N/A'}</td></tr>
                        <tr><td>Mobile</td><td>${staff.mobile_number || 'N/A'}</td></tr>
                        <tr><td>Department</td><td>${staff.department || 'N/A'}</td></tr>
                        <tr><td>Role</td><td>${staff.role || 'N/A'}</td></tr>
                        <tr><td>Date of Birth</td><td>${staff.date_of_birth ? new Date(staff.date_of_birth).toLocaleDateString() : 'N/A'}</td></tr>
                    </tbody>
                </table>`;
                let timetableHtml = '<h4>No classes assigned.</h4>';
                if (timetable.length > 0) {
                    timetableHtml = `
                    <div class="data-table-container">
                        <table class="data-table">
                            <thead><tr><th>Day</th><th>Time</th><th>Class Name</th><th>Year & Section</th><th>Course Code</th></tr></thead>
                            <tbody>
                                ${timetable.map(cls => `<tr><td>${cls.day_of_week}</td><td>${formatTime12Hour(cls.start_time)} - ${formatTime12Hour(cls.end_time)}</td><td>${cls.class_name}</td><td>${cls.year} Year - Sec ${cls.section}</td><td>${cls.course_code || 'N/A'}</td></tr>`).join('')}
                            </tbody>
                        </table>
                    </div>`;
                }
                container.innerHTML = `<div class="page-header"><button class="back-button" onclick="populateStaffDirectory();"><i class="fas fa-arrow-left"></i> Back to Staff List</button><h2>Staff Profile</h2><div></div></div><div class="data-table-container" style="padding: 30px;"><div class="profile-page-grid"><div class="profile-picture-container"><img src="${staff.profile_picture_url || 'https://placehold.co/180x180'}" alt="Profile Picture" onerror="this.src='https://placehold.co/180x180'"></div><div class="profile-details-container"><h3 style="margin-bottom: 15px;">Personal Information</h3>${personalInfoHtml}</div></div></div><h3 style="margin-top: 30px; margin-bottom: 15px;">Handled Classes</h3>${timetableHtml}`;
            } catch (error) {
                console.error('Error fetching staff details:', error);
                container.innerHTML += `<p style="color:red;">Could not load staff details.</p>`;
            }
        }
        
        async function populateStaffDirectory() {
            const container = document.getElementById('staff-directory-view');
            showView('staff-directory-view');
            container.innerHTML = `<div class="page-header"><button class="back-button" onclick="showView('main-dashboard-view')"><i class="fas fa-arrow-left"></i> Back</button><h2>Staff Directory</h2><div></div></div><div id="staff-grid" class="staff-grid-container"><p>Loading staff...</p></div>`;
            try {
                const department = userProfileData.department || "CSE";
                const response = await fetch(`http://localhost:3001/api/staff/department/${department}`);
                if (!response.ok) throw new Error('Could not fetch staff data.');
                const staffList = await response.json();
                const staffGrid = document.getElementById('staff-grid');
                if (staffList.length === 0) {
                    staffGrid.innerHTML = '<p>No staff found in this department.</p>';
                    return;
                }
                staffGrid.innerHTML = staffList.map(staff => `<div class="staff-card" onclick="showStaffDetails(${staff.id})"><img src="${staff.profile_picture_url || 'https://placehold.co/90x90/cccccc/ffffff?text=S'}" alt="${staff.name}" onerror="this.onerror=null;this.src='https://placehold.co/90x90/cccccc/ffffff?text=S';"><h4>${staff.name}</h4><p>${staff.email}</p></div>`).join('');
            } catch (error) {
                console.error('Error populating staff directory:', error);
                document.getElementById('staff-grid').innerHTML = '<p style="color:red;">Failed to load staff list.</p>';
            }
        }

        async function populateClassManagementView() {
            const container = document.getElementById('class-management-view');
            showView('class-management-view');
            container.innerHTML = `<div class="page-header"><button class="back-button" onclick="showView('main-dashboard-view')"><i class="fas fa-arrow-left"></i> Back</button><h2>Class Management</h2><div></div></div><div id="hod-class-grid-container" class="hod-class-grid"><p>Loading classes...</p></div>`;
            try {
                const department = userProfileData.department;
                const res = await fetch(`http://localhost:3001/api/hod/classes/${department}`);
                const data = await res.json();
                if (!data.success) throw new Error(data.message);
                const gridContainer = document.getElementById('hod-class-grid-container');
                if (data.classes.length === 0) {
                    gridContainer.innerHTML = '<p>No classes found in your department.</p>';
                    return;
                }
                gridContainer.innerHTML = data.classes.map(cls => `<div class="hod-class-card"><div class="class-card-icon"><i class="fas fa-chalkboard-teacher"></i></div><h4 class="class-card-title">Year ${cls.year} - Section ${cls.section}</h4><p class="class-card-dept">${department}</p><button class="btn-primary btn-view" onclick="showClassAttendanceDetails('${cls.year}', '${cls.section}')">View Details</button></div>`).join('');
            } catch (error) {
                console.error("Failed to load classes:", error);
                document.getElementById('hod-class-grid-container').innerHTML = `<p style="color:red;">Could not load class list.</p>`;
            }
        }

        async function showClassAttendanceDetails(year, section) {
            const container = document.getElementById('class-attendance-details-view');
            showView('class-attendance-details-view');
            container.innerHTML = `<div class="page-header"><button class="back-button" onclick="populateClassManagementView()"><i class="fas fa-arrow-left"></i> Back to Classes</button></div><p>Loading attendance details...</p>`;
            try {
                const department = userProfileData.department;
                const res = await fetch(`http://localhost:3001/api/hod/attendance/${department}/${year}/${section}`);
                const data = await res.json();
                if (!data.success) throw new Error(data.message);
                renderAttendanceTable(container, year, section, data);
                setupAttendanceFilters(container.querySelector('#attendance-main-table')); 
            } catch (error) {
                console.error("Failed to load attendance:", error);
                container.innerHTML += `<p style="color:red;">Could not load attendance details.</p>`;
            }
        }

        function renderAttendanceTable(container, year, section, data) {
            const { students, attendance } = data;
            const attendanceByDate = {};
            attendance.forEach(rec => {
                const dateStr = new Date(rec.attendance_date).toISOString().split('T')[0];
                if (!attendanceByDate[dateStr]) attendanceByDate[dateStr] = {};
                if (!attendanceByDate[dateStr][rec.student_reg_no]) attendanceByDate[dateStr][rec.student_reg_no] = {};
                attendanceByDate[dateStr][rec.student_reg_no][rec.period_number] = rec;
            });

            const dates = Object.keys(attendanceByDate).sort((a, b) => new Date(b) - new Date(a)).slice(0, 3);
            
            let tableHTML = `
            <div class="attendance-details-header">
                <h2>${year} Year - Section ${section}</h2>
                <div class="filter-container">
                    <strong>Filter:</strong>
                    <button class="filter-btn active" data-filter="All">All</button>
                    <button class="filter-btn" data-filter="Absent">Absentees</button>
                    <button class="filter-btn" data-filter="On Duty">On Duty</button>
                </div>
            </div>
            <div class="data-table-container">
                <table class="data-table attendance-table" id="attendance-main-table">
                    <thead>
                        <tr>
                            <th class="student-name-col" rowspan="2">Student Name / Reg. No</th>`;
            
            dates.forEach(date => {
                const day = new Date(date + 'T00:00:00Z').toLocaleDateString('en-US', { weekday: 'long' });
                tableHTML += `<th colspan="7" class="day-header">${day}<br><small>${date}</small></th>`;
            });
            tableHTML += `</tr><tr class="period-header">`;
            
            dates.forEach(() => {
                for (let i = 1; i <= 7; i++) tableHTML += `<th>P${i}</th>`;
            });
            tableHTML += `</tr></thead><tbody>`;

            students.forEach(student => {
                let rowHTML = `<tr data-reg-no="${student.register_number}">
                                    <td class="student-name-col">
                                        <div>${student.student_name}</div>
                                        <div style="font-size:0.8em; color:#6c757d;">${student.register_number}</div>
                                    </td>`;

                dates.forEach(date => {
                    for (let period = 1; period <= 7; period++) {
                        const record = attendanceByDate[date]?.[student.register_number]?.[period];
                        if (record) {
                            rowHTML += `<td data-status="${record.status}">`;
                            if (record.status === 'Present') {
                                rowHTML += `<span class="status-present">P</span>`;
                            } else {
                                const statusLabel = record.status === 'Absent' ? 'A' : 'OD';
                                const tooltipText = `Reason: ${record.reason || 'Not provided'}<br>By: ${record.staff_name || 'N/A'}<br>At: ${new Date(record.created_at).toLocaleString()}`;
                                rowHTML += `<div class="tooltip">
                                                <span class="status-${record.status.toLowerCase().replace(' ', '')}">${statusLabel}</span>
                                                <span class="tooltiptext">${tooltipText}</span>
                                            </div>`;
                            }
                            rowHTML += `</td>`;
                        } else {
                            rowHTML += `<td>-</td>`;
                        }
                    }
                });
                rowHTML += `</tr>`;
                tableHTML += rowHTML;
            });
            tableHTML += `</tbody></table></div>`;
            
            container.innerHTML = `<div class="page-header"><button class="back-button" onclick="populateClassManagementView()"><i class="fas fa-arrow-left"></i> Back to Classes</button></div>` + tableHTML;
        }
        function setupAttendanceFilters(table) {
            if (!table) return;
            const filterButtons = document.querySelectorAll('#class-attendance-details-view .filter-btn');
            filterButtons.forEach(button => {
                button.addEventListener('click', () => {
                    filterButtons.forEach(btn => btn.classList.remove('active'));
                    button.classList.add('active');
                    
                    const filter = button.dataset.filter;
                    const rows = table.querySelectorAll('tbody tr');

                    rows.forEach(row => {
                        if (filter === 'All') {
                            row.style.display = '';
                        } else {
                            const cellsWithStatus = row.querySelectorAll(`td[data-status="${filter}"]`);
                            if (cellsWithStatus.length > 0) {
                                row.style.display = '';
                            } else {
                                row.style.display = 'none';
                            }
                        }
                    });
                });
            });
        }
        
        async function populateMarkManagementView() {
            const container = document.getElementById('mark-management-view');
            showView('mark-management-view');
            container.innerHTML = `<div class="page-header"><button class="back-button" onclick="showView('main-dashboard-view')"><i class="fas fa-arrow-left"></i> Back</button><h2>Mark Management - Select Class</h2><div></div></div><div id="hod-mark-class-grid" class="hod-class-grid"><p>Loading classes...</p></div>`;
            try {
                const department = userProfileData.department;
                const res = await fetch(`http://localhost:3001/api/hod/classes/${department}`);
                const data = await res.json();
                if (!data.success) throw new Error(data.message);
                const gridContainer = document.getElementById('hod-mark-class-grid');
                if (data.classes.length === 0) {
                    gridContainer.innerHTML = '<p>No classes found in your department.</p>';
                    return;
                }
                gridContainer.innerHTML = data.classes.map(cls => `<div class="hod-class-card"><div class="class-card-icon"><i class="fas fa-marker"></i></div><h4 class="class-card-title">Year ${cls.year} - Section ${cls.section}</h4><p class="class-card-dept">${department}</p><button class="btn-primary btn-view" onclick="showMarkEntryView('${cls.year}', '${cls.section}', '${department}')">Enter Marks</button></div>`).join('');
            } catch (error) {
                console.error("Failed to load classes for marks:", error);
                document.getElementById('hod-mark-class-grid').innerHTML = `<p style="color:red;">Could not load class list.</p>`;
            }
        }
        
        async function showMarkEntryView(year, section, department) {
            const container = document.getElementById('mark-entry-view');
            showView('mark-entry-view');
            container.innerHTML = `<div class="page-header"><button class="back-button" onclick="populateMarkManagementView()"><i class="fas fa-arrow-left"></i> Back</button><h2>Marks for ${year} Year - Sec ${section}</h2><div></div></div><p>Loading students and marks...</p>`;
            try {
                const res = await fetch(`http://localhost:3001/api/marks/${department}/${year}/${section}`);
                const data = await res.json();
                if (!data.success) throw new Error(data.message);
                if (data.students.length === 0) {
                    container.innerHTML += '<p>No students found for this class.</p>';
                    return;
                }
                const markTypes = ['cat1_marks', 'cat2_marks', 'sac1_marks', 'sac2_marks', 'sac3_marks', 'sac4_marks', 'sac5_marks', 'internal_total'];
                let tableHTML = `<div class="page-header"><button class="back-button" onclick="populateMarkManagementView()"><i class="fas fa-arrow-left"></i> Back</button><h2>Marks for ${year} Year - Sec ${section}</h2><div><button class="btn-primary btn-edit" id="edit-marks-btn"><i class="fas fa-edit"></i> Edit</button><button class="btn-primary btn-save" id="save-marks-btn" style="display:none;"><i class="fas fa-save"></i> Save</button></div></div><div class="data-table-container"><table class="data-table marks-table" id="marks-entry-table"><thead><tr><th>Student Name</th><th>Register No</th><th>CAT-1</th><th>CAT-2</th><th>SAC-1</th><th>SAC-2</th><th>SAC-3</th><th>SAC-4</th><th>SAC-5</th><th>Total</th></tr></thead><tbody>`;
                data.students.forEach(student => {
                    tableHTML += `<tr data-reg-no="${student.register_number}"><td>${student.student_name}</td><td>${student.register_number}</td>`;
                    markTypes.forEach(type => { tableHTML += `<td><input type="number" name="${type}" value="${student[type] || ''}" readonly></td>`; });
                    tableHTML += `</tr>`;
                });
                tableHTML += `</tbody></table></div>`;
                container.innerHTML = tableHTML;
                document.getElementById('edit-marks-btn').addEventListener('click', () => {
                    document.querySelectorAll('#marks-entry-table input').forEach(input => input.readOnly = false);
                    document.getElementById('edit-marks-btn').style.display = 'none';
                    document.getElementById('save-marks-btn').style.display = 'inline-flex';
                });
                document.getElementById('save-marks-btn').addEventListener('click', () => saveAllMarks(year, section, department));
            } catch (error) {
                console.error("Failed to load marks entry view:", error);
                container.innerHTML = `<div class="page-header"><button class="back-button" onclick="populateMarkManagementView()"><i class="fas fa-arrow-left"></i> Back</button></div><p style="color:red;">Could not load student marks.</p>`;
            }
        }

        async function saveAllMarks(year, section, department) {
            const saveBtn = document.getElementById('save-marks-btn');
            saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
            saveBtn.disabled = true;
            const rows = document.querySelectorAll('#marks-entry-table tbody tr');
            const marksData = [];
            rows.forEach(row => {
                const studentMarks = { reg_no: row.dataset.regNo };
                row.querySelectorAll('input').forEach(input => { studentMarks[input.name] = input.value === '' ? null : parseFloat(input.value); });
                marksData.push(studentMarks);
            });
            try {
                const res = await fetch('http://localhost:3001/api/marks/save', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ marksData, year, section, department }) });
                const result = await res.json();
                if (!result.success) throw new Error(result.message);
                alert('Marks saved successfully!');
                document.querySelectorAll('#marks-entry-table input').forEach(input => input.readOnly = true);
                document.getElementById('edit-marks-btn').style.display = 'inline-flex';
                document.getElementById('save-marks-btn').style.display = 'none';
            } catch (error) {
                console.error('Error saving marks:', error);
                alert('Failed to save marks.');
            } finally {
                saveBtn.innerHTML = '<i class="fas fa-save"></i> Save';
                saveBtn.disabled = false;
            }
        }
        
        async function populateFullTimetableView() {
            const container = document.getElementById('timetable-view');
            showView('timetable-view');
            container.innerHTML = `<div class="page-header"><button class="back-button" onclick="showView('main-dashboard-view')"><i class="fas fa-arrow-left"></i> Back</button><h2>Full Weekly Timetable</h2></div><p>Loading timetable...</p>`;
            try {
                const res = await fetch(`http://localhost:3001/api/staff/timetables/${userProfileData.id}`);
                const timetable = await res.json();
                if (timetable.length === 0) {
                    container.innerHTML += '<p>No classes found in your timetable.</p>';
                    return;
                }

                const daysOfWeek = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
                let timetableGridHtml = '<div class="timetable-grid">';
                
                daysOfWeek.forEach(day => {
                    const classesForDay = timetable.filter(cls => cls.day_of_week === day)
                                                .sort((a, b) => a.start_time.localeCompare(b.start_time));
                    timetableGridHtml += `<div class="day-column"><h3>${day}</h3><ul>`;
                    if (classesForDay.length > 0) {
                        classesForDay.forEach(cls => {
                            timetableGridHtml += `
                                <li>
                                    <span class="time">${formatTime12Hour(cls.start_time)} - ${formatTime12Hour(cls.end_time)}</span>
                                    <span>${cls.class_name}</span>
                                    <span class="class-details">Year ${cls.year}, Sec ${cls.section}</span>
                                    <span class="class-details">Course: ${cls.course_code || 'N/A'}</span>
                                </li>`;
                        });
                    } else {
                        timetableGridHtml += '<li>No classes scheduled.</li>';
                    }
                    timetableGridHtml += '</ul></div>';
                });

                timetableGridHtml += '</div>';
                container.innerHTML = `<div class="page-header"><button class="back-button" onclick="showView('main-dashboard-view')"><i class="fas fa-arrow-left"></i> Back</button><h2>Full Weekly Timetable</h2></div>` + timetableGridHtml;
            } catch(error) {
                console.error("Failed to load timetable:", error);
                container.innerHTML += '<p style="color:red">Could not load timetable.</p>';
            }
        }
        
        function populateNewProfilePage(profile) {
            const formContainer = document.getElementById('user-profile-form');
            const imageUrl = profile.profile_picture_url ? `${profile.profile_picture_url}?t=${new Date().getTime()}` : 'https://placehold.co/180x180/cccccc/ffffff?text=No+Img';
            
            formContainer.innerHTML = `
                <div class="profile-page-grid">
                    <div class="profile-picture-container">
                        <img src="${imageUrl}" alt="Profile Picture" id="profile-image-preview" onerror="this.onerror=null;this.src='https://placehold.co/180x180/cccccc/ffffff?text=No+Img';">
                        <label for="profile-picture-upload" class="btn-primary btn-upload"><i class="fas fa-upload"></i> Upload Photo</label>
                        <input type="file" id="profile-picture-upload" accept="image/*">
                    </div>
                    <div class="profile-details-container">
                        <div class="form-group">
                            <label>Full Name</label>
                            <input type="text" value="${profile.name || ''}" readonly>
                        </div>
                        <div class="form-group">
                            <label>Email / Username</label>
                            <input type="email" value="${profile.email || ''}" readonly>
                        </div>
                        <div class="form-group">
                            <label>Role</label>
                            <input type="text" value="${profile.role || ''}" readonly>
                        </div>
                        <div class="form-group">
                            <label>New Password</label>
                            <input type="password" id="new-password-field" placeholder="Enter new password to change" readonly>
                        </div>
                    </div>
                </div>`;

            document.getElementById('edit-profile-btn').addEventListener('click', enableProfileEditing);
            document.getElementById('save-profile-btn').addEventListener('click', saveProfileChanges);
            document.getElementById('profile-picture-upload').addEventListener('change', previewProfileImage);
        }
        
        function enableProfileEditing() {
            document.getElementById('new-password-field').readOnly = false;
            document.querySelector('.profile-picture-container .btn-upload').style.display = 'inline-flex';
            document.getElementById('edit-profile-btn').style.display = 'none';
            document.getElementById('save-profile-btn').style.display = 'inline-flex';
        }

        async function saveProfileChanges() {
              const newPassword = document.getElementById('new-password-field').value;
              const pictureFile = document.getElementById('profile-picture-upload').files[0];
              const saveButton = document.getElementById('save-profile-btn');
              saveButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
              saveButton.disabled = true;
              try {
                   if (newPassword) {
                        await fetch(`http://localhost:3001/api/profile/password`, {
                            method: 'PATCH',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ email: userProfileData.email, password: newPassword })
                        });
                   }
                   if (pictureFile) {
                        const formData = new FormData();
                        formData.append('profile_picture', pictureFile);
                        formData.append('email', userProfileData.email);
                        const response = await fetch(`http://localhost:3001/api/profile/picture`, { method: 'POST', body: formData });
                        const result = await response.json();
                        if (result.success) {
                            userProfileData.profile_picture_url = result.filePath;
                            localStorage.setItem('loggedInUser', JSON.stringify(userProfileData));
                        } else { throw new Error(result.message || 'Image upload failed'); }
                   }
                   alert("Profile changes saved successfully!");
                   await initializeDashboard(userProfileData);
                   populateNewProfilePage(userProfileData); // Refresh the view
              } catch (error) {
                   console.error("Error saving profile:", error);
                   alert("Error saving profile: " + error.message);
              } finally {
                   document.getElementById('new-password-field').readOnly = true;
                   document.getElementById('new-password-field').value = '';
                   document.querySelector('.profile-picture-container .btn-upload').style.display = 'none';
                   document.getElementById('edit-profile-btn').style.display = 'inline-flex';
                   saveButton.style.display = 'none';
                   saveButton.innerHTML = '<i class="fas fa-save"></i> Save Changes';
                   saveButton.disabled = false;
              }
        }
        function previewProfileImage(event) {
            const reader = new FileReader();
            reader.onload = function(){
                document.getElementById('profile-image-preview').src = reader.result;
            };
            if(event.target.files.length > 0){
                reader.readAsDataURL(event.target.files[0]);
            }
        }

        async function populateAttendanceManagementView() {
            const container = document.getElementById('attendance-management-view');
            showView('attendance-management-view');
            container.innerHTML = `<div class="page-header"><button class="back-button" onclick="showView('main-dashboard-view')"><i class="fas fa-arrow-left"></i> Back</button><h2>Attendance Report - Select Class</h2></div><div id="hod-attendance-class-grid" class="hod-class-grid"><p>Loading classes...</p></div>`;
            try {
                const department = userProfileData.department;
                const res = await fetch(`http://localhost:3001/api/hod/classes/${department}`);
                const data = await res.json();
                if (!data.success) throw new Error(data.message);
                const gridContainer = document.getElementById('hod-attendance-class-grid');
                if (data.classes.length === 0) {
                    gridContainer.innerHTML = '<p>No classes found in your department.</p>';
                    return;
                }
                gridContainer.innerHTML = data.classes.map(cls => `<div class="hod-class-card"><div class="class-card-icon"><i class="fas fa-file-pdf"></i></div><h4 class="class-card-title">Year ${cls.year} - Section ${cls.section}</h4><p class="class-card-dept">${department}</p><button class="btn-primary btn-view" onclick="showAttendanceReportGenerator('${cls.year}', '${cls.section}', '${department}')">Generate Report</button></div>`).join('');
            } catch (error) {
                console.error("Failed to load classes for attendance report:", error);
                document.getElementById('hod-attendance-class-grid').innerHTML = `<p style="color:red;">Could not load class list.</p>`;
            }
        }

        function showAttendanceReportGenerator(year, section, department) {
            const container = document.getElementById('attendance-details-view');
            showView('attendance-details-view');
            let contentHTML = `
                <div class="report-view-header">
                     <button class="back-button" onclick="populateAttendanceManagementView()"><i class="fas fa-arrow-left"></i> Back</button>
                     <h2>Report for ${year} Year - Sec ${section}</h2>
                     <button class="btn-primary btn-secondary" id="downloadReportBtn" style="display:none;" onclick="generateAttendancePDFReport()"><i class="fas fa-download"></i> Download</button>
                </div>
                
                <div class="report-controls">
                    <div class="form-group">
                        <label for="from-date">From Date</label>
                        <input type="date" id="from-date">
                    </div>
                    <div class="form-group">
                        <label for="to-date">To Date</label>
                        <input type="date" id="to-date">
                    </div>
                    <button class="btn-primary" onclick="viewAttendanceReport('${year}', '${section}', '${department}')">View Attendance</button>
                </div>

                <div class="data-table-container" id="report-table-container">
                    </div>
            `;
            container.innerHTML = contentHTML;
        }

        async function viewAttendanceReport(year, section, department) {
            const fromDate = document.getElementById('from-date').value;
            const toDate = document.getElementById('to-date').value;
            const tableContainer = document.getElementById('report-table-container');
            const downloadBtn = document.getElementById('downloadReportBtn');

            if (!fromDate || !toDate) {
                alert("Please select both 'From' and 'To' dates.");
                return;
            }

            tableContainer.style.display = 'block';
            tableContainer.innerHTML = '<p>Loading report...</p>';
            downloadBtn.style.display = 'none';
            currentReportData = null; 

            try {
                const res = await fetch(`http://localhost:3001/api/hod/attendance/by-date-range/${department}/${year}/${section}?fromDate=${fromDate}&toDate=${toDate}`);
                const data = await res.json();
                
                if (!data.success || data.report.length === 0) {
                    tableContainer.innerHTML = '<p>No attendance data found for the selected date range.</p>';
                    return;
                }

                currentReportData = { report: data.report, fromDate, toDate, year, section };

                let tableHTML = `
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Student Name</th>
                                    <th>Register No</th>
                                    <th>Present</th>
                                    <th>Absent</th>
                                    <th>On Duty</th>
                                    <th>Total %</th>
                                </tr>
                            </thead>
                            <tbody>
                `;
                data.report.forEach(student => {
                    tableHTML += `
                                <tr>
                                    <td>${student.student_name}</td>
                                    <td>${student.register_number}</td>
                                    <td>${student.present_count}</td>
                                    <td>${student.absent_count}</td>
                                    <td>${student.onduty_count}</td>
                                    <td>${student.attendance_percentage}%</td>
                                </tr>
                            `;
                });
                tableHTML += `</tbody></table>`;
                
                tableContainer.innerHTML = tableHTML;
                downloadBtn.style.display = 'inline-flex';

            } catch (error) {
                console.error('Error fetching attendance report:', error);
                tableContainer.innerHTML = '<p style="color:red;">Failed to fetch the report.</p>';
            }
        }
        
        function generateAttendancePDFReport() {
            if (!currentReportData) {
                alert("Please view a report first before downloading.");
                return;
            }
            const { report, fromDate, toDate, year, section } = currentReportData;
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            doc.setFontSize(16);
            doc.text("Attendance Report", 14, 15);
            doc.setFontSize(12);
            doc.text(`Class: ${year} Year - Section ${section}`, 14, 22);
            doc.text(`Period: ${fromDate} to ${toDate}`, 14, 29);

            const tableData = report.map(student => [
                student.register_number,
                student.student_name,
                student.present_count,
                student.absent_count,
                student.onduty_count,
                `${student.attendance_percentage}%`
            ]);

            doc.autoTable({
                startY: 35,
                head: [['Register No', 'Student Name', 'Present', 'Absent', 'On Duty', 'Percentage']],
                body: tableData,
                theme: 'grid',
                headStyles: { fillColor: [244, 58, 9] }
            });
            
            doc.save(`Attendance_Report_${year}yr_${section}sec_${fromDate}_to_${toDate}.pdf`);
        }

        async function populateCalendarView() {
            const container = document.getElementById('calendar-view');
            showView('calendar-view');
            container.innerHTML = `<div class="page-header"><button class="back-button" onclick="showView('main-dashboard-view')"><i class="fas fa-arrow-left"></i> Back</button><h2>Academic Calendar</h2></div><div id="hod-calendar-container" class="calendar-container"><p>Loading calendar...</p></div>`;
            
            const now = new Date();
            await renderCalendar(now.getFullYear(), now.getMonth());
        }
        
        // **FIXED FUNCTION**
        async function renderCalendar(year, month) {
            const container = document.getElementById('hod-calendar-container');
            const events = await fetchCalendarEvents(year, month);
            const monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
            
            let calendarHTML = `
                <div class="calendar-header">
                    <button id="prev-month"><i class="fas fa-chevron-left"></i></button>
                    <h3>${monthNames[month]} ${year}</h3>
                    <button id="next-month"><i class="fas fa-chevron-right"></i></button>
                </div>
                <div class="calendar-grid">
                    <div class="calendar-day-name">Sun</div>
                    <div class="calendar-day-name">Mon</div>
                    <div class="calendar-day-name">Tue</div>
                    <div class="calendar-day-name">Wed</div>
                    <div class="calendar-day-name">Thu</div>
                    <div class="calendar-day-name">Fri</div>
                    <div class="calendar-day-name">Sat</div>
                `;

            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();

            for (let i = 0; i < firstDay; i++) {
                calendarHTML += `<div class="calendar-day not-current-month"></div>`;
            }

            for (let day = 1; day <= daysInMonth; day++) {
                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const dayEvents = events.filter(e => e.calendar_date === dateStr); // FIX: Use 'calendar_date'
                let dayClass = 'calendar-day';
                let dayActivity = '';
                
                if (dayEvents.length > 0) {
                    if(dayEvents[0].is_working_day === 0) dayClass += ' holiday';
                    dayActivity = `<div class="day-activity">${dayEvents[0].activity_description}</div>`; // FIX: Use 'activity_description'
                }

                calendarHTML += `<div class="${dayClass}" data-date="${dateStr}">
                                    <div class="day-number">${day}</div>
                                    ${dayActivity}
                                 </div>`;
            }
            
            calendarHTML += '</div>';
            container.innerHTML = calendarHTML;

            document.getElementById('prev-month').onclick = () => {
                const newDate = new Date(year, month - 1);
                renderCalendar(newDate.getFullYear(), newDate.getMonth());
            };
            document.getElementById('next-month').onclick = () => {
                const newDate = new Date(year, month + 1);
                renderCalendar(newDate.getFullYear(), newDate.getMonth());
            };

            container.querySelectorAll('.calendar-day[data-date]').forEach(dayCell => {
                dayCell.onclick = () => {
                    const date = dayCell.dataset.date;
                    const dayEvents = events.filter(e => e.calendar_date === date); // FIX: Use 'calendar_date'
                    showEventsForDate(date, dayEvents);
                };
            });
        }

        // **FIXED FUNCTION**
        async function fetchCalendarEvents(year, month) {
            try {
                // FIX: Corrected the API endpoint
                const res = await fetch(`http://localhost:3001/api/admin/calendar?year=${year}&month=${month + 1}`);
                const data = await res.json();
                return data.success ? data.data : []; // FIX: Use 'data' property from backend response
            } catch (error) {
                console.error('Failed to fetch calendar events:', error);
                return [];
            }
        }

        // **FIXED FUNCTION**
        function showEventsForDate(date, events) {
            const modal = document.getElementById('event-details-modal');
            const title = document.getElementById('event-details-title');
            const content = document.getElementById('event-details-content');
            
            title.textContent = `Details for ${new Date(date + 'T00:00:00').toLocaleDateString()}`;
            
            if (events.length > 0) {
                content.innerHTML = `<ul>${events.map(event => `
                    <li>
                        <h4>${event.activity_description}</h4>
                        <p>${event.is_working_day ? 'Working Day' : 'Non-Working Day / Holiday'}</p>
                    </li>
                `).join('')}</ul>`; // FIX: Use correct property names
            } else {
                content.innerHTML = `<p>This is a normal working day with no special events.</p>`;
            }
            modal.classList.add('active');
        }

        document.addEventListener('DOMContentLoaded', () => {
            const loggedInUser = JSON.parse(localStorage.getItem('loggedInUser') || 'null');
            if (loggedInUser) {
                initializeDashboard(loggedInUser);
                setupEventListeners();
            } else {
                window.location.href = 'login.html';
            }
        });
    </script>
</body>
</html>
